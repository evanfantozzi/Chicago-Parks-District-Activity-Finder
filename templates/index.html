<!doctype html>
<html>
    <head>
        <title>Find Available Activities in Chicago</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        
        <!-- Roboto Slab -->
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
      
        <link rel="stylesheet" href="/static/index.css" />

    </head>
    
<script>
    window.userLocationMarker = null;
    window.mapMarkers = [];
    window.allParks = {{ parks|tojson }};
    
    function initializeMap() {
      window.map = L.map("map").setView([41.8781, -87.6298], 11.5);
      L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
        attribution: '&copy; OpenStreetMap & contributors, &copy; CARTO',
        subdomains: "abcd",
        maxZoom: 19
      }).addTo(window.map);
    }

    function filterDropdown(input) {
      const filter = input.value.toLowerCase();
      const dropdown = input.closest(".dropdown-content");
      let currentGroup = null;
      let groupHasMatch = false;

      dropdown.querySelectorAll(".dropdown-group, label").forEach(el => {
        if (el.classList.contains("dropdown-group")) {
          if (currentGroup && !groupHasMatch) {
            currentGroup.style.display = "none";
          }
          currentGroup = el;
          groupHasMatch = false;
          el.style.display = "none";
        } else {
          const match = el.textContent.toLowerCase().includes(filter);
          el.style.display = match ? "block" : "none";
          if (match && currentGroup) {
            groupHasMatch = true;
            currentGroup.style.display = "block";
          }
        }
      });

      if (currentGroup && !groupHasMatch) {
        currentGroup.style.display = "none";
      }
    }

    function updateSummary() {
      const summaryLines = [];
      const anyCat = document.getElementById("any_categories");
      const anyAge = document.getElementById("any_age_groups");

      if (anyCat.checked) {
        summaryLines.push("<li><strong>Activities:</strong> Any</li>");
      } else {
        const selectedCats = [...document.querySelectorAll('input[name="categories"]:checked')]
          .map(el => el.parentElement.textContent.trim());
        if (selectedCats.length) {
          summaryLines.push(`<li><strong>Activities:</strong> ${selectedCats.join(", ")}</li>`);
        }
      }

      if (anyAge.checked) {
        summaryLines.push("<li><strong>Age Groups:</strong> Any</li>");
      } else {
        const selectedAges = [...document.querySelectorAll('input[name="age_groups"]:checked')]
          .map(el => el.parentElement.textContent.trim());
        if (selectedAges.length) {
          summaryLines.push(`<li><strong>Age Groups:</strong> ${selectedAges.join(", ")}</li>`);
        }
      }

      summaryLines.push("<li><strong>Parks/Facilities:</strong></li>");
      document.getElementById("form-summary").innerHTML =
        summaryLines.length
          ? `<ul style="margin: 0 0 1rem 0; padding-left: 1rem;">${summaryLines.join("")}</ul>`
          : "No filters selected.";
    }

    function enforceAnyCheckboxRules() {
      const enforce = (anyId, groupName) => {
        const anyCheckbox = document.getElementById(anyId);
        const groupCheckboxes = document.querySelectorAll(`input[name="${groupName}"]`);

        anyCheckbox.addEventListener("change", () => {
          if (anyCheckbox.checked) {
            groupCheckboxes.forEach(cb => cb.checked = false);
            updateSummary();
          }
        });

        groupCheckboxes.forEach(cb => {
          cb.addEventListener("change", () => {
            if (cb.checked) {
              anyCheckbox.checked = false;
              updateSummary();
            }
          });
        });
      };

      enforce("any_categories", "categories");
      enforce("any_age_groups", "age_groups");
    }

    function updateNearbyButtonLabel() {
      const input = document.getElementById("distance");
      const button = document.getElementById("nearby-btn");
      const val = input.value.trim();
      button.textContent = val
        ? `Look For Locations Within ${val} Miles`
        : "Get Locations";
    }

    function loadNearbyParks() {
        const radius = parseFloat(document.getElementById("distance").value || "2");

        if (!navigator.geolocation) {
            console.warn("Geolocation not available");
            return;
        }

        navigator.geolocation.getCurrentPosition(pos => {
            const userLatLng = [pos.coords.latitude, pos.coords.longitude];

            // 🛠️ NEW: check only hidden checkboxes
            document.querySelectorAll('input[name="parks"]').forEach(cb => {
                const park = window.allParks.find(p => p.name.trim().toLowerCase() === cb.value.trim().toLowerCase());
                if (!park) return;
                const dist = haversineDistance(userLatLng, [park.latitude, park.longitude]);
                cb.checked = dist <= radius;
            });

            updateSummary();
            updateMapFromManualSelection();
        }, err => {
            console.warn("Geolocation error", err);
        });
    }




    function renderMapMarkers(data, userLatLng = null, centerView = true) {
    if (!window.map) return;
    window.mapMarkers.forEach(m => m.remove());
    window.mapMarkers = [];
    data.forEach(p => {
        const marker = L.marker([p.latitude, p.longitude]).addTo(map).bindPopup(p.name);
        window.mapMarkers.push(marker);
    });

    // Don't REMOVE the old user marker automatically
    if (userLatLng) {
        if (window.userLocationMarker) {
            map.removeLayer(window.userLocationMarker);
        }
        window.userLocationMarker = L.marker(userLatLng, {
            icon: L.icon({
                iconUrl: "https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi2_hdpi.png",
                iconSize: [27, 43],
                iconAnchor: [13, 41],
                popupAnchor: [0, -36]
            })
        }).addTo(map).bindPopup("You are here").openPopup();
    }

    if (centerView && (window.mapMarkers.length || window.userLocationMarker)) {
        const bounds = [];

        window.mapMarkers.forEach(m => bounds.push(m.getLatLng()));
        if (window.userLocationMarker) {
            bounds.push(window.userLocationMarker.getLatLng());
        }

        map.fitBounds(bounds, { padding: [35, 35] });
    }
}


    function renderParkList(data, userLatLng = null) {
      const parkList = document.getElementById("park-list");
      parkList.innerHTML = "";
      data.forEach((p, i) => {
        const li = document.createElement("li");
        li.textContent = p.name;
        li.style.cursor = "pointer";
        li.addEventListener("click", () => {
          window.mapMarkers[i].openPopup();
          map.setView([p.latitude, p.longitude], 14);
        });
        parkList.appendChild(li);
      });
      document.getElementById("clear-parks-btn").style.display =
        data.length ? "block" : "none";
    }

    function haversineDistance([lat1, lon1], [lat2, lon2]) {
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2
              + Math.sin(dLon / 2) ** 2 * Math.cos(toRad(lat1)) * Math.cos(toRad(lat2));
      return 3958.8 * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function populateParkDropdown(parks, userLatLng) {
    const parksCopy = [...parks];

    if (userLatLng) {
        parksCopy.sort((a, b) =>
            haversineDistance(userLatLng, [a.latitude, a.longitude]) -
            haversineDistance(userLatLng, [b.latitude, b.longitude])
        );
    } else {
        parksCopy.sort((a, b) => a.name.localeCompare(b.name));
    }

    const dropdown = document.getElementById("parks-dropdown");

    // 🧹 Only remove existing <label> elements (NOT the <input> search box!)
    dropdown.querySelectorAll('label').forEach(label => label.remove());

    parksCopy.forEach(p => {
        const label = document.createElement("label");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.name = "parks";
        cb.value = p.name;
        cb.addEventListener("change", updateMapFromManualSelection);

        const dist = userLatLng
            ? ` (${haversineDistance(userLatLng, [p.latitude, p.longitude]).toFixed(1)} mi)`
            : "";

        label.append(cb, document.createTextNode(` ${p.name}${dist}`));

        // ✅ JUST append it to the dropdown, no insertBefore needed anymore
        dropdown.appendChild(label);
    });
}




    function clearParkSelection() {
      document.querySelectorAll('input[name="parks"]').forEach(cb => cb.checked = false);
      window.mapMarkers.forEach(m => m.remove());
      window.mapMarkers = [];
      if (window.userLocationMarker) {
        map.removeLayer(window.userLocationMarker);
        window.userLocationMarker = null;
      }
      map.setView([41.8781, -87.6298], 11.5);
      document.getElementById("clear-parks-btn").style.display = "none";
      updateSummary();
    }

    function updateMapFromManualSelection() {
        const selected = Array.from(document.querySelectorAll('input[name="parks"]:checked'))
            .map(cb => cb.value.trim().toLowerCase());

        const matched = window.allParks.filter(p => 
            selected.includes(p.name.trim().toLowerCase())
        );

        renderMapMarkers(matched);
        renderParkList(matched);
        document.getElementById("clear-parks-btn").style.display =
            matched.length ? "block" : "none";
        }


    // Update this function to handle the group toggle properly
    function initializeGroupCheckboxes() {
      document.querySelectorAll(".group-toggle").forEach(toggle => {
        const group = toggle.dataset.group;
        const groupCheckboxes = document.querySelectorAll(`input[name="categories"][data-group="${group}"]`);
        const checked = [...groupCheckboxes].filter(cb => cb.checked).length;
        toggle.checked = checked === groupCheckboxes.length;
        toggle.indeterminate = checked > 0 && checked < groupCheckboxes.length;
      });
    }

    function attachGroupToggleHandlers() {
      document.querySelectorAll(".group-toggle").forEach(toggle => {
        toggle.addEventListener("change", e => {
          const group = e.target.dataset.group;
          const groupCheckboxes = document.querySelectorAll(`input[name="categories"][data-group="${group}"]`);
          const isChecked = e.target.checked;
          
          // Select/Deselect all checkboxes in the group
          groupCheckboxes.forEach(cb => {
            cb.checked = isChecked;
            cb.dispatchEvent(new Event("change"));
          });
        });
      });

      // Update group toggle based on individual checkbox changes
      document.querySelectorAll('input[name="categories"]').forEach(cb => {
        cb.addEventListener("change", () => {
          const group = cb.dataset.group;
          const groupCheckboxes = document.querySelectorAll(`input[name="categories"][data-group="${group}"]`);
          const checkedCount = [...groupCheckboxes].filter(x => x.checked).length;
          const groupToggle = document.querySelector(`.group-toggle[data-group="${group}"]`);
          
          // Update the group toggle state
          if (checkedCount === groupCheckboxes.length) {
            groupToggle.checked = true;
            groupToggle.indeterminate = false;
          } else if (checkedCount > 0) {
            groupToggle.checked = false;
            groupToggle.indeterminate = true;
          } else {
            groupToggle.checked = false;
            groupToggle.indeterminate = false;
          }

          updateSummary();
        });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".dropdown-toggle").forEach(btn => {
        btn.addEventListener("click", () => btn.closest(".dropdown-checkbox").classList.toggle("open"));
      });
      document.addEventListener("click", e => {
        document.querySelectorAll(".dropdown-checkbox.open").forEach(dd => {
          if (!dd.contains(e.target)) dd.classList.remove("open");
        });
      });
      document.querySelectorAll("input[name='parks']").forEach(input => {
        input.addEventListener("change", updateMapFromManualSelection);
      });
      document.getElementById("distance").addEventListener("input", () => {
        updateSummary();
        updateNearbyButtonLabel();
      });
      document.querySelector("form").addEventListener("submit", e => {
        const hasDistance = document.querySelector('input[name="distance"]').value.trim();
        const hasParks = document.querySelectorAll('input[name="parks"]:checked').length;
        if (!hasDistance && !hasParks) {
          e.preventDefault();
          document.getElementById("form-summary").innerHTML =
            `<span style="color: red; font-weight: bold;">Please enter a distance or select at least one park before submitting.</span>`;
        }
      });

      initializeMap();
      loadNearbyParks();
      updateSummary();
      updateNearbyButtonLabel();
      enforceAnyCheckboxRules();
      initializeGroupCheckboxes();
      attachGroupToggleHandlers();

    navigator.geolocation.getCurrentPosition(pos => {
        const userLatLng = [pos.coords.latitude, pos.coords.longitude];
        document.getElementById("user-lat").value = pos.coords.latitude;
        document.getElementById("user-lon").value = pos.coords.longitude;

        // ✅ 1. Draw "You are here" first
        if (window.map) {
        if (window.userLocationMarker) {
            window.map.removeLayer(window.userLocationMarker);
        }
        window.userLocationMarker = L.marker(userLatLng, {
            icon: L.icon({
            iconUrl: "https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi2_hdpi.png",
            iconSize: [27, 43],
            iconAnchor: [13, 41],
            popupAnchor: [0, -36]
            })
        }).addTo(window.map).bindPopup("You are here").openPopup();
        }

        // ✅ 2. THEN populate the parks dropdown
        populateParkDropdown(window.allParks, userLatLng);

    });

    });
</script>


<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  
</head>
<body>
<video autoplay muted loop id="bg-video">
    <source src="static/video.mp4" type="video/mp4" />
    Your browser does not support HTML5 video.
    </video>
    <div class="section-header">
        <h1>Find Available Activities in Chicago</h1>
      </div>

<ul id="park-list" style="display: none;"; list-style: none; padding-left: 0;"></ul>

<form method="post" action="/search"  style="background: transparent; box-shadow: none;">
    <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">
  
      <!-- LEFT BLOCK -->
<div class="form-panel">
    <h2 class="form-section-header">Build Your Search Here:</h2>
    <fieldset>
        <legend>1. Find Nearby Parks/Facilities</legend>
        <div class="flex-row" style="margin-bottom: 0; margin-top: -1; align-items: center;">
          <div style="flex: 1;">
            <button type="button" id="nearby-btn" onclick="loadNearbyParks()" style="width: 100%;">
              Look For Locations Within 2 Miles
            </button>
          </div>
          <div style="flex: 0.5;">
            <label for="distance" style="display: block;">Miles away:</label>
            <input id="distance" name="distance" type="number" step="0.1" value="2" placeholder="e.g. 2"
                   style="width: 100%; padding: 0.4em 0.6em; font-size: 0.9rem;">
          </div>
        </div>
      </fieldset>
  
  
        <fieldset>
          <legend>2. Select Your Preferred Type(s) of Activities</legend>
          <label><input type="checkbox" name="any_categories" id="any_categories" checked> Any</label>
          <div class="dropdown-checkbox">
            <div class="dropdown-toggle">Select Activities <span class="example">(e.g. {{ all_categories[14].split(' - ')[-1] }})</span></div>
            <div class="dropdown-content">
              <input type="text" class="dropdown-search" placeholder="Search..." onkeyup="filterDropdown(this)">
              {% set ns = namespace(current_group='') %}
              {% for name in all_categories %} 
                {% set group = name.split(' - ')[0] %}
                {% if group != ns.current_group %}
                  <div class="dropdown-group">
                    <label>
                      <input type="checkbox" class="group-toggle" data-group="{{ group }}"> {{ group }}
                    </label>
                  </div>
                  {% set ns.current_group = group %}
                {% endif %}
                {% set label = name.split(' - ', 1)[1] if ' - ' in name else name %}
                <label>
                  <input type="checkbox" name="categories" value="{{ name }}" data-group="{{ group }}"> {{ label }}
                </label>
              {% endfor %}
              
            </div>
          </div>
        </fieldset>
  
        <fieldset>
          <legend>3. Select Your Preferred Age Group(s)</legend>
          <label><input type="checkbox" name="any_age_groups" id="any_age_groups" checked> Any</label>
          <div class="dropdown-checkbox">
            <div class="dropdown-toggle">Select Age Group(s) <span class="example">(e.g. {{ all_age_groups[0] }})</span></div>
            <div class="dropdown-content">
              <input type="text" class="dropdown-search" placeholder="Search..." onkeyup="filterDropdown(this)">
              {% for name in all_age_groups %}
                <label><input type="checkbox" name="age_groups" value="{{ name }}"> {{ name }}</label>
              {% endfor %}
            </div>
          </div>
        </fieldset>
        <fieldset class="thin-fieldset">
            <legend>4. Number of Open Slots</legend>
            <div class="flex-row">
              <input id="open-slots" name="open_slots" type="number" min="0" step="1" placeholder="e.g. 1"
                     style="width: 100%; padding: 0.4em 0.6em; font-size: 0.9rem;">
            </div>
          </fieldset>
      </div>
  
      <!-- RIGHT BLOCK -->
      <div class="form-panel">
        <h2 class="form-section-header">Your Search Criteria:</h2>
        <div id="form-summary" style="font-size: 0.95rem; line-height: 1.5; margin-bottom: 1rem;"></div>
        <div style="position: relative; height: 350px; margin-bottom: 0.5rem;">
          <div id="map" style="height: 100%; border: 1px solid #ccc; border-radius: 10px;"></div>
          <button type="button" id="clear-parks-btn" onclick="clearParkSelection()">✕ Clear</button>
        </div>
        <label style="margin-bottom: 0.3rem;"></label>
        <div class="dropdown-checkbox dropdown-up">
            <div class="dropdown-toggle"> <span class="example">(Optional) Add or remove specific parks/facilities</span></div>
            <div class="dropdown-content" id="parks-dropdown">
              <input type="text" class="dropdown-search" placeholder="Search..." onkeyup="filterDropdown(this)">
              <!-- dynamic parks will be inserted here -->
            </div>
        </div>          
</div>

<div style="width: 100%; margin-top: 0.0rem;">
    <input type="hidden" id="user-lat" name="user_lat">
    <input type="hidden" id="user-lon" name="user_lon">
    <button type="submit" style="width: calc(100% - 2rem); margin: 0 0; display: block;">Search</button>
  </div>
  
</form>
</body>
</html>
  