<!doctype html>
<html>
    <head>
        <title>Find Available Activities in Chicago</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        
        <!-- Add Google Fonts for Roboto Slab -->
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
        <!-- Leaflet CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
        <!-- Leaflet JS -->
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <!-- Leaflet Control Geocoder CSS and JS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
        <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

        <style>
          :root {
            --accent: #007acc;
            --bg: #f9fafb;
            --border: #ccc;
            --shadow: rgba(0, 0, 0, 0.08);
          }
      
          body {
            font-family: 'Montserrat', serif; 
            background: var(--bg);
            margin: 0;
            padding: 2rem 2rem 1rem 2rem;
            color: #333;
          }
      
          h1 {
            text-align: center;
            color: #155e27; /* dark green */
            background: white;
            padding: 0.4rem 1rem;
            border-radius: 8px;
            display: inline-block;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 0.8rem; /* adjust as needed */
          }
      
          .section-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0rem;
            padding-top: 0.0rem;
          }
      
          .section-header::before,
          .section-header::after {
            content: "";
            flex: 1;
            height: 1px;
            background-color: white;
            margin: 0 1rem;
            opacity: 0.6;
          }
      
          .section-header h1 {
            text-align: center;
            color: #155e27; /* dark green */
            background: white;
            padding: 0.4rem 1rem;
            border-radius: 8px;
            display: inline-block;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            margin: 0;
          }
      
          form {
            max-width: 100%;   /* previously 720px */
            width: 90%;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 16px var(--shadow);
          }
      
          .summary-bar {
            background: #f4f4f4;
            border: 1px solid var(--border);
            padding: 0.8em 1em;
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
            border-radius: 6px;
            color: #333;
            line-height: 1.5;
          }
      
          fieldset {
            border: 1px solid #e0e0e0;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
          }
      
          .location-container {
            flex: 1;
            max-width: 50%;
            min-width: 300px;
          }
      
          @media (max-width: 768px) {
            .location-container {
                max-width: 100%;
            }
          }
      
          .form-panel {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            flex: 1;
            min-width: 300px;
            max-width: 100%
          }
      
          .form-section-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin: -0.5rem 0 1rem 0.5rem;
            text-align: center;
          }
      
          legend {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.1rem; /* reduce space below legend */
          }
      
          .flex-row {
            display: flex;
            justify-content: space-between;
            gap: 1.5rem; /* Adjusts space between elements */
            align-items: center; /* Aligns both the button and input to the same height */
          }
      
          label {
            margin: 0.4em 0;
            display: block;
          }
      
          .location-container fieldset {
            margin-top: 0;
            padding-top: 0;
          }
      
          .location-container legend {
            margin-bottom: 0.3rem;
          }
      
          .flex-col {
            margin: 0; /* remove vertical spacing */
          }
      
          .flex-col label {
            margin: 0 0 0.3rem 0;
          }
      
          input[type="number"] {
            width: 100%;
            padding: 0.75em;
            font-size: 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            box-sizing: border-box;
          }
      
          .dropdown-checkbox {
            position: relative;
            display: block;
            width: 100%;
          }
      
          .dropdown-toggle {
            width: 85%;
            padding: 0.75em;
            border: 1px solid var(--border);
            background-color: white;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            text-align: left;
          }
      
          .dropdown-toggle:hover {
            background-color: #f0f0f0;
          }
      
          .dropdown-toggle .example {
            font-size: 0.95rem;
            color: #555;
            font-style: italic;
            margin-left: 0.6rem;
            opacity: 0.8;
          }
      
          .dropdown-checkbox.dropdown-up .dropdown-content {
            top: auto !important;
            bottom: 100% !important;
            margin-top: 2 !important;
            margin-bottom: 0px;
            z-index: 9999 !important; /* force on top */
          }
      
          .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            z-index: 10;
            max-height: 250px;
            overflow-y: auto;
            width: 100%;
            box-shadow: 0px 6px 10px var(--shadow);
            margin-top: 4px;
          }
      
          .dropdown-checkbox.open .dropdown-content {
            display: block;
          }
      
          .dropdown-content label {
            padding: 0.4em 1em;
            cursor: pointer;
          }
      
          .dropdown-content label:hover {
            background-color: #f5f5f5;
          }
      
          .dropdown-search {
            width: 85%;
            padding: 0.6em 1em;
            border: none;
            border-bottom: 1px solid #eee;
            font-size: 1rem;
            box-sizing: border-box;
            outline: none;
          }
      
          .dropdown-group {
            font-weight: bold;
            background-color: #f8f8f8;
            padding: 0em 0em;
            border-top: 0px solid #eee;
          }
      
          .flex-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: flex-end;
          }
      
          .flex-col {
            flex: 1;
            min-width: 250px;
          }
      
          .or-divider {
            align-self: center;
            font-weight: bold;
            font-size: 1.1rem;
            color: #666;
            padding: 0 0.75rem;
            cursor: help;
          }
      
          button {
            display: block;
            width: 100%;
            padding: 0.8em;
            font-size: 1rem;
            font-weight: bold;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s ease-in-out;
          }
      
          #bg-video {
            position: fixed;
            top: 0;
            left: 0;
            min-width: 100%;
            min-height: 100%;
            object-fit: cover;
            z-index: -2; /* push it behind the overlay */
          }
      
          #clear-parks-btn {
            display: none; /* start hidden */
            position: absolute;
            top: 15px;
            right: 12px;
            background-color: #e74c3c;
            color: white;
            font-size: 0.8rem;
            border: none;
            margin-top: 1.5rem;
            padding: 10px 10px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: background 0.2s ease-in-out;
            width: auto;
            min-width: 64px;
            max-width: 20%;
          }
      
          #park-list {
            display: none;
            margin-top: 1rem;
            list-style: none;
            padding-left: 0;
          }
      
          #clear-parks-btn:hover {
            background-color: #c0392b;
          }
      
          button:hover {
            background-color: #005fa3;
          }
      
          @media (max-width: 600px) {
            form {
              padding: 0rem;
            }
          }
      
          @media (max-width: 768px) {
            body > div {
              flex-direction: column;
            }
      
            #map, #selected-parks-list {
              width: 100%;
              margin-bottom: 1rem
            }
      
            #clear-parks-btn:hover {
              background-color: #c0392b;
            }
      
            form {
              max-width: 100%;
            }
          }
     </style>

<script>
    window.userLocationMarker = null;
    window.mapMarkers = [];
    window.allParks = {{ parks|tojson }};
    
    function initializeMap() {
      window.map = L.map("map").setView([41.8781, -87.6298], 11.5);
      L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
        attribution: '&copy; OpenStreetMap & contributors, &copy; CARTO',
        subdomains: "abcd",
        maxZoom: 19
      }).addTo(window.map);
    }

    function filterDropdown(input) {
      const filter = input.value.toLowerCase();
      const dropdown = input.closest(".dropdown-content");
      let currentGroup = null;
      let groupHasMatch = false;

      dropdown.querySelectorAll(".dropdown-group, label").forEach(el => {
        if (el.classList.contains("dropdown-group")) {
          if (currentGroup && !groupHasMatch) {
            currentGroup.style.display = "none";
          }
          currentGroup = el;
          groupHasMatch = false;
          el.style.display = "none";
        } else {
          const match = el.textContent.toLowerCase().includes(filter);
          el.style.display = match ? "block" : "none";
          if (match && currentGroup) {
            groupHasMatch = true;
            currentGroup.style.display = "block";
          }
        }
      });

      if (currentGroup && !groupHasMatch) {
        currentGroup.style.display = "none";
      }
    }

    function updateSummary() {
      const summaryLines = [];
      const anyCat = document.getElementById("any_categories");
      const anyAge = document.getElementById("any_age_groups");

      if (anyCat.checked) {
        summaryLines.push("<li><strong>Activities:</strong> Any</li>");
      } else {
        const selectedCats = [...document.querySelectorAll('input[name="categories"]:checked')]
          .map(el => el.parentElement.textContent.trim());
        if (selectedCats.length) {
          summaryLines.push(`<li><strong>Activities:</strong> ${selectedCats.join(", ")}</li>`);
        }
      }

      if (anyAge.checked) {
        summaryLines.push("<li><strong>Age Groups:</strong> Any</li>");
      } else {
        const selectedAges = [...document.querySelectorAll('input[name="age_groups"]:checked')]
          .map(el => el.parentElement.textContent.trim());
        if (selectedAges.length) {
          summaryLines.push(`<li><strong>Age Groups:</strong> ${selectedAges.join(", ")}</li>`);
        }
      }

      summaryLines.push("<li><strong>Parks/Facilities:</strong></li>");
      document.getElementById("form-summary").innerHTML =
        summaryLines.length
          ? `<ul style="margin: 0 0 1rem 0; padding-left: 1rem;">${summaryLines.join("")}</ul>`
          : "No filters selected.";
    }

    function enforceAnyCheckboxRules() {
      const enforce = (anyId, groupName) => {
        const anyCheckbox = document.getElementById(anyId);
        const groupCheckboxes = document.querySelectorAll(`input[name="${groupName}"]`);

        anyCheckbox.addEventListener("change", () => {
          if (anyCheckbox.checked) {
            groupCheckboxes.forEach(cb => cb.checked = false);
            updateSummary();
          }
        });

        groupCheckboxes.forEach(cb => {
          cb.addEventListener("change", () => {
            if (cb.checked) {
              anyCheckbox.checked = false;
              updateSummary();
            }
          });
        });
      };

      enforce("any_categories", "categories");
      enforce("any_age_groups", "age_groups");
    }

    function updateNearbyButtonLabel() {
      const input = document.getElementById("distance");
      const button = document.getElementById("nearby-btn");
      const val = input.value.trim();
      button.textContent = val
        ? `Look For Locations Within ${val} Miles`
        : "Get Locations";
    }

    function loadNearbyParks() {
      const radius = parseFloat(document.querySelector('input[name="distance"]').value || "2");

      if (!navigator.geolocation) {
        populateParkDropdown(null);
        return;
      }

      navigator.geolocation.getCurrentPosition(pos => {
        const userLatLng = [pos.coords.latitude, pos.coords.longitude];
        fetch("/find_nearby_parks", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ lat: pos.coords.latitude, lon: pos.coords.longitude, radius })
        })
        .then(res => res.json())
        .then(data => {
          populateParkDropdown(userLatLng);
          const parkNames = data.map(p => p.name.trim().toLowerCase());
          document.querySelectorAll('input[name="parks"]').forEach(cb => {
            cb.checked = parkNames.includes(cb.value.trim().toLowerCase());
          });
          updateSummary();
          renderMapMarkers(data, userLatLng);
          renderParkList(data);
        });
      }, err => {
        console.warn("Geolocation error", err);
        populateParkDropdown(null);
      });
    }

    function renderMapMarkers(data, userLatLng = null, centerView = true) {
      if (!window.map) return;
      window.mapMarkers.forEach(m => m.remove());
      window.mapMarkers = [];
      data.forEach(p => {
        const marker = L.marker([p.latitude, p.longitude]).addTo(map).bindPopup(p.name);
        window.mapMarkers.push(marker);
      });
      if (window.userLocationMarker) {
        map.removeLayer(window.userLocationMarker);
        window.userLocationMarker = null;
      }
      if (userLatLng) {
        window.userLocationMarker = L.marker(userLatLng, {
          icon: L.icon({
            iconUrl: "https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi2_hdpi.png",
            iconSize: [27, 43],
            iconAnchor: [13, 41],
            popupAnchor: [0, -36]
          })
        }).addTo(map).bindPopup("You are here").openPopup();
      }
      if (centerView && window.mapMarkers.length) {
        const bounds = window.mapMarkers.map(m => m.getLatLng());
        map.fitBounds(bounds, { padding: [35, 35] });
      }
    }

    function renderParkList(data, userLatLng = null) {
      const parkList = document.getElementById("park-list");
      parkList.innerHTML = "";
      data.forEach((p, i) => {
        const li = document.createElement("li");
        li.textContent = p.name;
        li.style.cursor = "pointer";
        li.addEventListener("click", () => {
          window.mapMarkers[i].openPopup();
          map.setView([p.latitude, p.longitude], 14);
        });
        parkList.appendChild(li);
      });
      document.getElementById("clear-parks-btn").style.display =
        data.length ? "block" : "none";
    }

    function haversineDistance([lat1, lon1], [lat2, lon2]) {
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2
              + Math.sin(dLon / 2) ** 2 * Math.cos(toRad(lat1)) * Math.cos(toRad(lat2));
      return 3958.8 * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function populateParkDropdown(userLatLng) {
      const dropdown = document.getElementById("parks-dropdown");
      dropdown.querySelectorAll("label").forEach(el => el.remove());
      const parks = [...window.allParks];
      if (userLatLng) {
        parks.sort((a, b) => haversineDistance(userLatLng, [a.latitude, a.longitude])
                          - haversineDistance(userLatLng, [b.latitude, b.longitude]));
      } else {
        parks.sort((a, b) => a.name.localeCompare(b.name));
      }
      parks.forEach(p => {
        const label = document.createElement("label");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.name = "parks";
        cb.value = p.name;
        cb.addEventListener("change", updateMapFromManualSelection);
        const dist = userLatLng
          ? ` (${haversineDistance(userLatLng, [p.latitude, p.longitude]).toFixed(1)} mi)`
          : "";
        label.append(cb, document.createTextNode(` ${p.name}${dist}`));
        dropdown.insertBefore(label, dropdown.querySelector("#park-list"));
      });
    }

    function clearParkSelection() {
      document.querySelectorAll('input[name="parks"]').forEach(cb => cb.checked = false);
      window.mapMarkers.forEach(m => m.remove());
      window.mapMarkers = [];
      if (window.userLocationMarker) {
        map.removeLayer(window.userLocationMarker);
        window.userLocationMarker = null;
      }
      map.setView([41.8781, -87.6298], 11.5);
      document.getElementById("clear-parks-btn").style.display = "none";
      updateSummary();
    }

    function updateMapFromManualSelection() {
      const selected = Array.from(document.querySelectorAll('input[name="parks"]:checked'))
        .map(cb => cb.value.trim().toLowerCase());
      fetch("/find_nearby_parks", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lat: 41.8781, lon: -87.6298, radius: 100 })
      })
      .then(res => res.json())
      .then(data => {
        const matched = selected
          .map(name => data.find(p => p.name.trim().toLowerCase() === name))
          .filter(Boolean);
        renderMapMarkers(matched);
        renderParkList(matched);
        document.getElementById("clear-parks-btn").style.display =
          matched.length ? "block" : "none";
      });
    }

    // Update this function to handle the group toggle properly
    function initializeGroupCheckboxes() {
      document.querySelectorAll(".group-toggle").forEach(toggle => {
        const group = toggle.dataset.group;
        const groupCheckboxes = document.querySelectorAll(`input[name="categories"][data-group="${group}"]`);
        const checked = [...groupCheckboxes].filter(cb => cb.checked).length;
        toggle.checked = checked === groupCheckboxes.length;
        toggle.indeterminate = checked > 0 && checked < groupCheckboxes.length;
      });
    }

    function attachGroupToggleHandlers() {
      document.querySelectorAll(".group-toggle").forEach(toggle => {
        toggle.addEventListener("change", e => {
          const group = e.target.dataset.group;
          const groupCheckboxes = document.querySelectorAll(`input[name="categories"][data-group="${group}"]`);
          const isChecked = e.target.checked;
          
          // Select/Deselect all checkboxes in the group
          groupCheckboxes.forEach(cb => {
            cb.checked = isChecked;
            cb.dispatchEvent(new Event("change"));
          });
        });
      });

      // Update group toggle based on individual checkbox changes
      document.querySelectorAll('input[name="categories"]').forEach(cb => {
        cb.addEventListener("change", () => {
          const group = cb.dataset.group;
          const groupCheckboxes = document.querySelectorAll(`input[name="categories"][data-group="${group}"]`);
          const checkedCount = [...groupCheckboxes].filter(x => x.checked).length;
          const groupToggle = document.querySelector(`.group-toggle[data-group="${group}"]`);
          
          // Update the group toggle state
          if (checkedCount === groupCheckboxes.length) {
            groupToggle.checked = true;
            groupToggle.indeterminate = false;
          } else if (checkedCount > 0) {
            groupToggle.checked = false;
            groupToggle.indeterminate = true;
          } else {
            groupToggle.checked = false;
            groupToggle.indeterminate = false;
          }

          updateSummary();
        });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".dropdown-toggle").forEach(btn => {
        btn.addEventListener("click", () => btn.closest(".dropdown-checkbox").classList.toggle("open"));
      });
      document.addEventListener("click", e => {
        document.querySelectorAll(".dropdown-checkbox.open").forEach(dd => {
          if (!dd.contains(e.target)) dd.classList.remove("open");
        });
      });
      document.querySelectorAll("input[name='parks']").forEach(input => {
        input.addEventListener("change", updateMapFromManualSelection);
      });
      document.getElementById("distance").addEventListener("input", () => {
        updateSummary();
        updateNearbyButtonLabel();
      });
      document.querySelector("form").addEventListener("submit", e => {
        const hasDistance = document.querySelector('input[name="distance"]').value.trim();
        const hasParks = document.querySelectorAll('input[name="parks"]:checked').length;
        if (!hasDistance && !hasParks) {
          e.preventDefault();
          document.getElementById("form-summary").innerHTML =
            `<span style="color: red; font-weight: bold;">Please enter a distance or select at least one park before submitting.</span>`;
        }
      });

      initializeMap();
      loadNearbyParks();
      updateSummary();
      updateNearbyButtonLabel();
      enforceAnyCheckboxRules();
      initializeGroupCheckboxes();
      attachGroupToggleHandlers();

      navigator.geolocation.getCurrentPosition(pos => {
        document.getElementById("user-lat").value = pos.coords.latitude;
        document.getElementById("user-lon").value = pos.coords.longitude;
        }, err => {
        console.warn("Geolocation error", err);
        openAddressModal(); // <-- Automatically open the address popup
        });
    });
</script>

<script>
    function openAddressModal() {
        document.getElementById('address-modal').style.display = 'flex';

        // Only initialize geocoder once
        if (!window.addressGeocoder) {
            window.addressGeocoder = L.Control.geocoder({
            defaultMarkGeocode: false,
            placeholder: 'Enter an address...',
            collapsed: false
            })
            .on('markgeocode', function(e) {
            const center = e.geocode.center;
            document.getElementById('user-lat').value = center.lat;
            document.getElementById('user-lon').value = center.lng;
            closeAddressModal();
            alert('Address found! Now you can search.');
            });

            // Attach the search box inside the modal
            const container = window.addressGeocoder.onAdd(map); // 'map' already exists
            document.getElementById('geocoder-container').appendChild(container);
        }
    }

  
    function closeAddressModal() {
      document.getElementById('address-modal').style.display = 'none';
    }
  
    async function submitAddress() {
      const address = document.getElementById('address-input').value.trim();
      if (!address) {
        alert('Please enter a valid address.');
        return;
      }
  
      try {
        // Use Nominatim (OpenStreetMap free geocoding API)
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
        const data = await response.json();
  
        if (data.length === 0) {
          alert('Address not found. Please try a more specific address.');
          return;
        }
  
        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);
  
        // Set lat/lon hidden inputs
        document.getElementById('user-lat').value = lat;
        document.getElementById('user-lon').value = lon;
  
        closeAddressModal();
        alert('Address found! Now you can search as normal.');
      } catch (error) {
        console.error('Error during geocoding:', error);
        alert('Error finding address. Please try again.');
      }
    }
  </script>
  

  
</head>
<body>
<video autoplay muted loop id="bg-video">
    <source src="static/video.mp4" type="video/mp4" />
    Your browser does not support HTML5 video.
    </video>
    <div class="section-header">
        <h1>Find Available Activities in Chicago</h1>
      </div>

      

<form method="post" action="/search"  style="background: transparent; box-shadow: none;">
    <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">
  
      <!-- LEFT BLOCK -->
<div class="form-panel">
    <h2 class="form-section-header">Build Your Search Here:</h2>
    <fieldset>
        <legend>1. Find Nearby Parks/Facilities</legend>
        <button type="button" onclick="openAddressModal()" style="margin-top:1rem; background:#007acc; color:white; width:100%; padding:0.7em; font-size:1rem; border:none; border-radius:6px; cursor:pointer;">
            Enter Address Manually
          </button>
        <div class="flex-row" style="margin-bottom: 0; margin-top: -1; align-items: center;">
          <div style="flex: 1;">
            <button type="button" id="nearby-btn" onclick="loadNearbyParks()" style="width: 100%;">
              Look For Locations Within 2 Miles
            </button>
          </div>
          <div style="flex: 0.5;">
            <label for="distance" style="display: block;">Miles away:</label>
            <input id="distance" name="distance" type="number" step="0.1" value="2" placeholder="e.g. 2"
                   style="width: 100%; padding: 0.4em 0.6em; font-size: 0.9rem;">
          </div>
        </div>
      </fieldset>
  
  
        <fieldset>
          <legend>2. Select Your Preferred Type(s) of Activities</legend>
          <label><input type="checkbox" name="any_categories" id="any_categories" checked> Any</label>
          <div class="dropdown-checkbox">
            <div class="dropdown-toggle">Select Activities <span class="example">(e.g. {{ all_categories[14].split(' - ')[-1] }})</span></div>
            <div class="dropdown-content">
              <input type="text" class="dropdown-search" placeholder="Search..." onkeyup="filterDropdown(this)">
              {% set ns = namespace(current_group='') %}
              {% for name in all_categories %} 
                {% set group = name.split(' - ')[0] %}
                {% if group != ns.current_group %}
                  <div class="dropdown-group">
                    <label>
                      <input type="checkbox" class="group-toggle" data-group="{{ group }}"> {{ group }}
                    </label>
                  </div>
                  {% set ns.current_group = group %}
                {% endif %}
                {% set label = name.split(' - ', 1)[1] if ' - ' in name else name %}
                <label>
                  <input type="checkbox" name="categories" value="{{ name }}" data-group="{{ group }}"> {{ label }}
                </label>
              {% endfor %}
              
            </div>
          </div>
        </fieldset>
  
        <fieldset>
          <legend>3. Select Your Preferred Age Group(s)</legend>
          <label><input type="checkbox" name="any_age_groups" id="any_age_groups" checked> Any</label>
          <div class="dropdown-checkbox">
            <div class="dropdown-toggle">Select Age Group(s) <span class="example">(e.g. {{ all_age_groups[0] }})</span></div>
            <div class="dropdown-content">
              <input type="text" class="dropdown-search" placeholder="Search..." onkeyup="filterDropdown(this)">
              {% for name in all_age_groups %}
                <label><input type="checkbox" name="age_groups" value="{{ name }}"> {{ name }}</label>
              {% endfor %}
            </div>
          </div>
        </fieldset>
        <fieldset class="thin-fieldset">
            <legend>4. Number of Open Slots</legend>
            <div class="flex-row">
              <input id="open-slots" name="open_slots" type="number" min="0" step="1" placeholder="e.g. 1"
                     style="width: 100%; padding: 0.4em 0.6em; font-size: 0.9rem;">
            </div>
          </fieldset>
      </div>
  
      <!-- RIGHT BLOCK -->
      <div class="form-panel">
        <h2 class="form-section-header">Your Search Criteria:</h2>
        <div id="form-summary" style="font-size: 0.95rem; line-height: 1.5; margin-bottom: 1rem;"></div>
        <div style="position: relative; height: 350px; margin-bottom: 0.5rem;">
          <div id="map" style="height: 100%; border: 1px solid #ccc; border-radius: 10px;"></div>
          <button type="button" id="clear-parks-btn" onclick="clearParkSelection()">✕ Clear</button>
        </div>
        <label style="margin-bottom: 0.3rem;"></label>
        <div class="dropdown-checkbox dropdown-up">
            <div class="dropdown-toggle"> <span class="example">(Optional) Add or remove specific parks/facilities</span></div>
            <div class="dropdown-content" id="parks-dropdown">
              <input type="text" class="dropdown-search" placeholder="Search..." onkeyup="filterDropdown(this)">
              <!-- dynamic parks will be inserted here -->
              <ul id="park-list" style="margin-top: 1rem; list-style: none; padding-left: 0;"></ul>
            </div>
        </div>          
</div>

<div style="width: 100%; margin-top: 0.0rem;">
    <input type="hidden" id="user-lat" name="user_lat">
    <input type="hidden" id="user-lon" name="user_lon">
    <button type="submit" style="width: calc(100% - 2rem); margin: 0 0; display: block;">Search</button>
  </div>
</form>
 
  
<div id="address-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:10px; width:90%; max-width:400px; box-shadow:0 4px 12px rgba(0,0,0,0.3); position:relative;">
      <h2 style="margin-top:0;">Enter Your Address</h2>
      <div id="geocoder-container" style="margin:1rem 0;"></div> <!-- placeholder for search box -->
      <div style="display:flex; justify-content:space-between; gap:1rem;">
        <button onclick="closeAddressModal()" style="flex:1; background:#e74c3c; color:white; padding:0.7em; border:none; border-radius:6px; font-size:1rem; cursor:pointer;">Cancel</button>
      </div>
    </div>
  </div>
  
  
  </body>
</html>
  